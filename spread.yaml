project: charmed-kafka-docs-tutorial

# The project root is mirrored to this path inside the test VM.
path: /charmed-kafka

backends:
  multipass:
    type: adhoc
    allocate: |
      instance_name="kafka-tutorial-vm"

      # 8 CPUs / 16 GB RAM / 50 GB disk â€“ sized for a 6-unit Juju/LXD cluster.
      # Adjust SPREAD_VM_CPUS, SPREAD_VM_MEM, SPREAD_VM_DISK to override.
      cpus="${SPREAD_VM_CPUS:-8}"
      mem="${SPREAD_VM_MEM:-16G}"
      disk="${SPREAD_VM_DISK:-50G}"

      multipass launch --cpus "$cpus" --disk "$disk" --memory "$mem" \
        --name "$instance_name" 24.04

      # Fix DNS inside the VM (systemd-resolved can mis-configure on Multipass).
      multipass exec "$instance_name" -- \
        sudo sh -c "echo 'DNS=8.8.8.8 8.8.4.4' >> /etc/systemd/resolved.conf && systemctl restart systemd-resolved"

      # Fix MTU: upstream path MTU is 1492 (PPPoE); set the VM NIC to match so
      # large TCP packets (snap downloads, LXD traffic) are not silently dropped.
      multipass exec "$instance_name" -- \
        sudo ip link set ens3 mtu 1492

      # Pre-install snaps while MTU is correct and we are still in the allocate
      # phase.  On Ubuntu 24.04, /usr/sbin/lxd is a stub that triggers a snap
      # install when first invoked; doing it here avoids races inside the test.
      multipass exec "$instance_name" -- \
        sudo snap install lxd --channel=5.21/stable
      multipass exec "$instance_name" -- \
        sudo snap install juju --channel=3/stable

      # Allow root SSH login so Spread can connect.
      multipass exec "$instance_name" -- \
        sudo sh -c "echo root:${SPREAD_PASSWORD} | chpasswd"
      multipass exec "$instance_name" -- \
        sudo sh -c \
        "if [ -d /etc/ssh/sshd_config.d/ ]; then
           echo 'PasswordAuthentication yes' > /etc/ssh/sshd_config.d/10-spread.conf
           echo 'PermitRootLogin yes'       >> /etc/ssh/sshd_config.d/10-spread.conf
         else
           sed -i /etc/ssh/sshd_config -E \
             -e 's/^#?PasswordAuthentication.*/PasswordAuthentication yes/' \
             -e 's/^#?PermitRootLogin.*/PermitRootLogin yes/'
         fi"
      multipass exec "$instance_name" -- sudo systemctl restart ssh

      ip=$(multipass info --format csv "$instance_name" | tail -1 | cut -d, -f3)
      ADDRESS "$ip"

    discard: |
      instance_name="kafka-tutorial-vm"
      multipass delete --purge "$instance_name"

    systems:
      - ubuntu-24.04-64:
          workers: 1

suites:
  tests/:
    summary: Charmed Apache Kafka documentation tutorial
    systems:
      - ubuntu-24.04-64
